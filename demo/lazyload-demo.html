<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tree/paper-tree.html">

<dom-module id="lazyload-demo">
    <template>
        <style>
            :host {
                display: block;

                --loading-icon-theme: {
                    content: '';
                    background:url('loading.svg');
                    background-size:cover;
                    position:absolute;
                    width:24px;
                    height:24px;
                    margin-left:-24px;
                };
            }
        </style>
        <h2>Lazy loading paper-tree demo</h2>
        <p>Here we use the 'toggle' event to lazy load grandchildren.<br>
            We've added some delay so you can see the effect of the loading icon.</p>
        <paper-tree on-toggle="onToggle" data=[[doc]]></paper-tree>
    </template>

    <script>
        Polymer({

            is: 'lazyload-demo',

            properties: {
                doc:{
                    type: Object,
                    value: {
                        name: 'Loading...'
                    }
                }
            },

            ready: function(){
                var self = this;
                // Update the root doc for the tree after 1 second delay
                window.setTimeout(function() {
                    var rootDoc = {name:'Cronos', updatePath:'doc'};
                    self.doc = rootDoc;

                    //var rootNode = self.root;
                    //TODO find the span that will have the loading class
                    //self.toggleClass('loading', true, [rootNode]);

                    // Add the children to the root.
                    self.addChildrenToNode(rootDoc);
                }, 1000);
            },

            onToggle: function(event){
                var self = this;
                var nodeData = Polymer.dom(event).rootTarget.data;
                //We only have to get the grandchildren once
                if(nodeData.gotGrandChildren) return;
                nodeData.gotGrandChildren = true;

                nodeData.children.forEach(function(child){
                    //Add grandchildren to the child.
                    self.addChildrenToNode(child);
                });
            },

            addChildrenToNode: function(treeNode){
                var self = this;
                // Wait a couple of seconds to simulate async data retrieval
                window.setTimeout(function() {

                    var updatePath = treeNode.updatePath+'.children';
                    var children = [
                        {name:'Zeus', updatePath:updatePath+'.0'},
                        {name:'Apollo', updatePath:updatePath+'.1'},
                        {name:'Athena', updatePath:updatePath+'.2'},
                        {name:'Poseidon', updatePath:updatePath+'.3'}
                    ];

                    // We use set(updatePath... to trigger the correct valueChange events in the tree
                    // Simply setting children on the treeNode won't have any effect.
                    self.set(updatePath, children);

                }, Math.floor(Math.random() * 2000));
            }
        });
    </script>
</dom-module>

